<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Registro √önico ‚Äî Ocorr√™ncias (WhatsApp)</title>
  <meta name="description" content="Registrar UMA ocorr√™ncia por vez e enviar texto + card-imagem + anexos via WhatsApp. Campo 'Bloco/Setor' livre e captura de c√¢mera integrada." />
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{ --bg:#f6fbff; --paper:#fff; --ink:#0f172a; --muted:#667085; --line:#e5eef7; --brand:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --radius:16px }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .wrap{max-width:940px;margin:0 auto;padding:16px;height:100%;display:grid;grid-template-rows:auto 1fr auto;gap:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px}
    h1{margin:0;font-size:20px}
    .stamp{font-size:12px;color:var(--muted)}
    .card{background:var(--paper);border:2px solid var(--line);border-radius:var(--radius);box-shadow:0 16px 40px rgba(0,0,0,.06)}
    .form{padding:12px;display:grid;gap:10px;overflow:auto;max-height:calc(100vh - 190px)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:760px){.row{grid-template-columns:1fr}}
    label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    input,select,textarea{border:2px solid var(--line);border-radius:10px;padding:10px;font-size:14px}
    textarea{min-height:110px;resize:vertical;overflow:auto}
    .help{font-size:11px;color:var(--muted)}
    .actions{display:flex;flex-wrap:wrap;gap:8px;padding:10px}
    .btn{appearance:none;border:2px solid var(--line);background:var(--paper);border-radius:999px;padding:10px 14px;font-weight:700;color:var(--ink);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,#7dd3fc,#38bdf8);border-color:transparent;color:#063a59}
    .preview{padding:10px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f8fbff;border-top:2px dashed var(--line);max-height:220px;overflow:auto}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{width:70px;height:70px;object-fit:cover;border-radius:10px;border:2px solid var(--line)}
    .opts{display:flex;gap:12px;align-items:center}
    footer{font-size:11px;color:var(--muted);padding:8px;text-align:center}
    canvas{display:none}
    /* c√¢mera */
    .camBar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .camWrap{display:none;border:2px dashed var(--line);border-radius:12px;padding:10px}
    video{width:100%;max-height:260px;border-radius:10px;background:#000}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Registro √önico ‚Äî Ocorr√™ncias (WhatsApp)</h1>
        <div class="stamp">üïí Data/hora (Bras√≠lia): <b id="ts"></b></div>
      </div>
      <div class="opts">
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="chkCard" checked> Incluir *card‚Äëimagem* formatado</label>
        <button class="btn" id="btnClear">Limpar</button>
      </div>
    </header>

    <section class="card">
      <form id="form" class="form" novalidate>
        <div class="row">
          <label>Tipo de ocorr√™ncia
            <select id="tipo" required>
              <option value="" selected disabled>Selecione‚Ä¶</option>
              <option>Extravios</option>
              <option>Danos causados por terceiros</option>
              <option>Entupimentos</option>
              <option>Necessidade de reparo</option>
              <option>N√£o conformidade</option>
              <option>Acidente/Incidente</option>
              <option>Seguran√ßa</option>
              <option>Atraso de fornecedor</option>
              <option>Falta de material</option>
              <option>Outros</option>
            </select>
          </label>
          <label id="lblOutro" style="display:none">Descrever (se "Outros")
            <input id="outroTexto" placeholder="Ex.: vazamento em shaft do 12¬∫ andar" />
          </label>
        </div>

        <div class="row">
          <label>Bloco/Setor (livre ‚Äî n√∫mero ou local)
            <input id="bloco" placeholder="Ex.: 2 | Embasamento | √Åreas externas" list="blocosSug" />
            <datalist id="blocosSug">
              <option value="Bloco 1"></option>
              <option value="Bloco 2"></option>
              <option value="Bloco 3"></option>
              <option value="Embasamento"></option>
              <option value="√Åreas externas"></option>
            </datalist>
          </label>
          <label>Pavimento / Unidade (Apto/Loja)
            <input id="pav" placeholder="Ex.: 12¬∫ / 1203" />
          </label>
        </div>

        <div class="row">
          <label>Local detalhado
            <input id="local" placeholder="Ex.: banheiro social, shaft hidr√°ulico, QDL" />
          </label>
          <label>Respons√°vel/Equipe (opcional)
            <input id="resp" placeholder="Ex.: Equipe Hidr√°ulica ‚Äî Jo√£o" />
          </label>
        </div>

        <label>Descri√ß√£o objetiva (o que ocorreu?)
          <textarea id="desc" placeholder="Explique em 2‚Äì3 linhas o que foi visto/aconteceu."></textarea>
        </label>

        <div class="row">
          <label>A√ß√£o solicitada
            <select id="acao">
              <option>Vistoria</option>
              <option>Reparo</option>
              <option>Retorno administrativo</option>
              <option>Compra de material</option>
              <option>Fechamento de √°rea</option>
              <option>Outro</option>
            </select>
          </label>
          <label>Prioridade
            <select id="prio">
              <option>M√©dia</option>
              <option>Alta</option>
              <option>Cr√≠tica</option>
              <option>Baixa</option>
            </select>
          </label>
        </div>

        <div class="row">
          <label>Prazo desejado (se houver)
            <input type="date" id="prazo" />
          </label>
          <label>Telefone WhatsApp (DDD+N√∫mero)
            <input id="fone" type="tel" inputmode="numeric" pattern="[0-9]{10,13}" placeholder="Ex.: 21999999999" />
            <span class="help">Salvamos o √∫ltimo n√∫mero usado neste dispositivo.</span>
          </label>
        </div>

        <label>Anexos (opcional) ‚Äî fotos/v√≠deos
          <!-- input r√°pido que pede c√¢mera (mobile) -->
          <div class="camBar">
            <button class="btn" type="button" id="btnOpenCam">üì∑ Usar c√¢mera agora</button>
            <span class="help">Funciona melhor via HTTPS e no celular. Em iOS/Android, o seletor abaixo j√° abre a c√¢mera com <code>capture</code>.</span>
          </div>
          <div class="camWrap" id="camWrap">
            <video id="cam" playsinline autoplay muted></video>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn primary" type="button" id="btnSnap">Tirar foto</button>
              <button class="btn" type="button" id="btnCloseCam">Fechar c√¢mera</button>
            </div>
          </div>
          <input id="midia" type="file" accept="image/*,video/*" multiple capture="environment" />
          <div class="thumbs" id="thumbs"></div>
          <div class="help">‚ö†Ô∏è WhatsApp Web n√£o aceita anexos por URL. Em celulares com <em>Web Share</em>, enviamos arquivos direto; no desktop, abriremos o card para voc√™ salvar e anexar.</div>
        </label>

        <div class="actions">
          <button class="btn" type="button" id="btnPreview">Pr√©‚Äëvisualizar</button>
          <button class="btn primary" type="submit" id="btnSend">Enviar via WhatsApp</button>
          <button class="btn" type="button" id="btnCopy">Copiar texto</button>
        </div>

        <div class="preview" id="preview" aria-live="polite"></div>
      </form>
    </section>

    <footer>‚Äî <strong><em>Registro para Gest√£o</em></strong></footer>
  </div>

  <!-- Canvas usado para gerar o card-imagem e para o snapshot da c√¢mera -->
  <canvas id="cardCanvas" width="1080" height="1350"></canvas>
  <canvas id="snapCanvas" width="1600" height="1200" style="display:none"></canvas>

  <script>
    // ====== Util: data/hora Bras√≠lia ======
    const tz = 'America/Sao_Paulo';
    function nowBr(){ const d = new Date(); return new Intl.DateTimeFormat('pt-BR',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d); }
    function ymdBrParts(){ const d = new Date(); const z = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).formatToParts(d); const g = Object.fromEntries(z.map(p=>[p.type,p.value])); return g; }
    function makeRef(){ const g = ymdBrParts(); return `OC-${g.year}${g.month}${g.day}-${g.hour}${g.minute}`; }
    function isoBrDate(d){ if(!d) return ''; const [y,m,da] = d.split('-'); return `${da}/${m}/${y}` }
    function refreshStamp(){ document.getElementById('ts').textContent = nowBr(); }
    setInterval(refreshStamp, 1000); refreshStamp();

    // ====== DOM refs ======
    const form = document.getElementById('form');
    const tipo = document.getElementById('tipo');
    const lblOutro = document.getElementById('lblOutro');
    const outroTexto = document.getElementById('outroTexto');
    const bloco = document.getElementById('bloco');
    const pav = document.getElementById('pav');
    const localDet = document.getElementById('local');
    const resp = document.getElementById('resp');
    const desc = document.getElementById('desc');
    const acao = document.getElementById('acao');
    const prio = document.getElementById('prio');
    const prazo = document.getElementById('prazo');
    const fone = document.getElementById('fone');
    const midia = document.getElementById('midia');
    const thumbs = document.getElementById('thumbs');
    const preview = document.getElementById('preview');
    const chkCard = document.getElementById('chkCard');
    const cardCanvas = document.getElementById('cardCanvas');

    // C√¢mera
    const camWrap = document.getElementById('camWrap');
    const cam = document.getElementById('cam');
    const btnOpenCam = document.getElementById('btnOpenCam');
    const btnCloseCam = document.getElementById('btnCloseCam');
    const btnSnap = document.getElementById('btnSnap');
    const snapCanvas = document.getElementById('snapCanvas');
    let camStream = null;

    // ====== Persist√™ncia do √∫ltimo n√∫mero ======
    const KEY_FONE = 'whats-fone-default';
    fone.value = localStorage.getItem(KEY_FONE) || '';
    fone.addEventListener('change', ()=> localStorage.setItem(KEY_FONE, (fone.value||'').replace(/\D/g,'')));

    // ====== UI din√¢mica ======
    tipo.addEventListener('change', ()=>{ lblOutro.style.display = (tipo.value === 'Outros') ? '' : 'none'; });
    midia.addEventListener('change', (e)=>{ thumbs.innerHTML = ''; const files = Array.from(e.target.files||[]).slice(0, 20); files.forEach(f=> addThumbFromFile(f)); });

    function addThumbFromFile(file){ const url = URL.createObjectURL(file); const img = document.createElement('img'); img.src = url; img.alt = file.name; thumbs.appendChild(img); }

    // ====== Template do texto para WhatsApp ======
    function buildMessage(){
      const ref = makeRef();
      const dataHora = nowBr();
      const t = tipo.value || '(sem tipo)';
      const t2 = (t === 'Outros' ? (outroTexto.value.trim()||'(descrever)') : t);
      const prazoFmt = (prazo.value? isoBrDate(prazo.value): '-');
      const anexos = ((midia.files||[]).length + extraFiles.length);
      const linhas = [
        `*üèóÔ∏è OCORR√äNCIA DE OBRA*  ‚Ä¢  *Ref:* ${ref}`,
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
        `*Tipo:* ${t2}`,
        `*üìç Bloco/Setor:* ${bloco.value||'-'}`,
        `*üè¢ Pav/Unidade:* ${pav.value||'-'}`,
        `*üß≠ Local:* ${localDet.value||'-'}`,
        `*üìù Descri√ß√£o:* ${desc.value.trim()||'-'}`,
        `*üõ†Ô∏è A√ß√£o solicitada:* ${acao.value}`,
        `*‚ö° Prioridade:* ${prio.value}`,
        `*üìÖ Prazo desejado:* ${prazoFmt}`,
        `*üë∑ Respons√°vel/Equipe:* ${resp.value||'-'}`,
        `*üïí Data/Hora (Bras√≠lia):* ${dataHora}`,
        anexos? `*üìé Anexos:* ${anexos} arquivo(s)` : null,
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
        `*_*Registro para Gest√£o*_*`
      ].filter(Boolean);
      return linhas.join('\n');
    }

    function updatePreview(){ preview.textContent = buildMessage(); }
    document.getElementById('btnPreview').addEventListener('click', updatePreview);
    document.getElementById('btnCopy').addEventListener('click', ()=>{ const text = buildMessage(); navigator.clipboard?.writeText(text).then(()=>{ preview.textContent = text + "\n\n(copiado para a √°rea de transfer√™ncia)"; }); });
    document.getElementById('btnClear').addEventListener('click', ()=>{ form.reset(); thumbs.innerHTML=''; extraFiles.length=0; updatePreview(); tipo.dispatchEvent(new Event('change')); stopCam(); });

    // ====== Gera√ß√£o do CARD (imagem) ======
    function wrapText(ctx, text, x, y, maxW, lineH){ const words = text.split(/\s+/); let line=''; const lines=[]; for(let i=0;i<words.length;i++){ const test=line+words[i]+' '; if(ctx.measureText(test).width>maxW && i>0){ lines.push(line.trim()); line=words[i]+' '; } else { line=test; } } lines.push(line.trim()); lines.forEach((ln,i)=>ctx.fillText(ln,x,y+i*lineH)); return y+(lines.length-1)*lineH; }

    async function buildCardFile(){ const W=1080,H=1350,P=64; const ctx=cardCanvas.getContext('2d'); ctx.clearRect(0,0,W,H); const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#eaf6ff'); g.addColorStop(1,'#ffffff'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); ctx.fillStyle='#0f172a'; ctx.font='bold 48px Inter, Arial'; ctx.fillText('OCORR√äNCIA DE OBRA', P, P+8); const ref=makeRef(); ctx.font='bold 28px Inter, Arial'; ctx.fillStyle='#0ea5e9'; ctx.fillText(`Ref: ${ref}`, P, P+54); const boxY=P+90, boxH=H-boxY-180, boxR=28; ctx.fillStyle='#00000010'; ctx.fillRect(P+6,boxY+6,W-P*2,boxH); ctx.fillStyle='#ffffff'; ctx.strokeStyle='#e5eef7'; ctx.lineWidth=4; const bw=W-P*2,bh=boxH,x=P,y=boxY,r=boxR; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+bw-r,y); ctx.quadraticCurveTo(x+bw,y,x+bw,y+r); ctx.lineTo(x+bw,y+bh-r); ctx.quadraticCurveTo(x+bw,y+bh,x+bw-r,y+bh); ctx.lineTo(x+r,y+bh); ctx.quadraticCurveTo(x,y+bh,x,y+bh-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.fillStyle='#0f172a'; ctx.font='600 34px Inter, Arial'; let yy=y+56; const lh=44, maxW=bw-40, xx=x+20; const linhas=[ `Tipo: ${tipo.value==='Outros' ? (outroTexto.value.trim()||'(descrever)') : (tipo.value||'(sem tipo)')}`, `Bloco/Setor: ${bloco.value||'-'}`, `Pav/Unidade: ${pav.value||'-'}`, `Local: ${localDet.value||'-'}`, `Descri√ß√£o:`]; linhas.forEach(t=>{ ctx.fillText(t,xx,yy); yy+=lh; }); ctx.font='400 30px Inter, Arial'; yy=wrapText(ctx,(desc.value.trim()||'-'),xx,yy,maxW,40)+26; ctx.font='600 34px Inter, Arial'; [ `A√ß√£o solicitada: ${acao.value}`, `Prioridade: ${prio.value}`, `Prazo desejado: ${prazo.value? isoBrDate(prazo.value): '-'}`, `Resp./Equipe: ${resp.value||'-'}`, `Data/Hora (Bras√≠lia): ${nowBr()}` ].forEach(t=>{ ctx.fillText(t,xx,yy); yy+=lh; }); ctx.font='italic 700 26px Inter, Arial'; ctx.fillStyle='#64748b'; ctx.fillText('‚Äî Registro para Gest√£o', P, H-90); ctx.save(); ctx.translate(W-140,H-70); ctx.rotate(-Math.PI/12); ctx.globalAlpha=0.08; ctx.fillStyle='#0ea5e9'; ctx.font='900 90px Inter, Arial'; ctx.fillText('SYSTEM', -200, 0); ctx.restore(); const blob = await new Promise(res=> cardCanvas.toBlob(res, 'image/png', 0.92)); return new File([blob], `ocorrencia_${ref}.png`, {type:'image/png'}); }

    // ====== C√ÇMERA: abrir, fechar, tirar foto ======
    async function openCam(){
      if(camStream) return; // j√° aberta
      try{
        const constraints = { video: { facingMode: { ideal: 'environment' } } , audio:false };
        camStream = await navigator.mediaDevices.getUserMedia(constraints);
        cam.srcObject = camStream; camWrap.style.display='block';
      }catch(err){
        alert('N√£o foi poss√≠vel acessar a c√¢mera. Garanta que est√° em HTTPS e permita o acesso. Voc√™ ainda pode usar o seletor de arquivos para abrir a c√¢mera.');
        console.warn(err);
      }
    }
    function stopCam(){ if(camStream){ camStream.getTracks().forEach(t=>t.stop()); cam.srcObject=null; camStream=null; camWrap.style.display='none'; } }

    async function snapPhoto(){
      if(!camStream){ await openCam(); if(!camStream) return; }
      const track = camStream.getVideoTracks()[0];
      const settings = track.getSettings();
      const w = settings.width || 1600; const h = settings.height || 1200;
      const sc = snapCanvas; sc.width = w; sc.height = h;
      const ctx = sc.getContext('2d'); ctx.drawImage(cam, 0, 0, w, h);
      const blob = await new Promise(res=> sc.toBlob(res, 'image/jpeg', 0.92));
      const ref = makeRef();
      const file = new File([blob], `foto_${ref}.jpg`, {type:'image/jpeg'});
      extraFiles.push(file);
      addThumbFromFile(file);
    }

    btnOpenCam.addEventListener('click', openCam);
    btnCloseCam.addEventListener('click', stopCam);
    btnSnap.addEventListener('click', snapPhoto);

    // ====== Lista adicional de arquivos (snapshots) ======
    const extraFiles = [];

    // ====== Envio para WhatsApp ======
    function openWhatsWithText(text, number){ const encoded = encodeURIComponent(text); const num = (number||'').replace(/\D/g,''); const base = num ? `https://wa.me/${num}?text=${encoded}` : `https://wa.me/?text=${encoded}`; window.open(base, '_blank'); }

    async function shareWithFiles(text){
      const files = Array.from(midia.files||[]).slice(0,10);
      const list = [...extraFiles, ...files];
      if(chkCard.checked){ try{ const card = await buildCardFile(); list.unshift(card); }catch(e){ console.warn('Falha ao gerar card', e); }}
      if(list.length && navigator.canShare && navigator.canShare({ files: list })){
        try{ await navigator.share({ files: list, text, title: 'Ocorr√™ncia de obra' }); return true; }catch(e){ return false; }
      }
      return false;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!tipo.value){ alert('Selecione o tipo de ocorr√™ncia.'); return; }
      if(tipo.value==='Outros' && !outroTexto.value.trim()){ alert('Descreva a ocorr√™ncia em "Outros".'); return; }
      updatePreview();
      const text = buildMessage();

      // 1) Tenta Web Share (mobile) com arquivos (inclui card/snapshots)
      const shared = await shareWithFiles(text);
      if(shared){ stopCam(); return; }

      // 2) Fallback desktop: abre WhatsApp (texto) e o card numa aba para salvar; snapshots j√° ficam nos thumbs
      if(chkCard.checked){
        try{
          const card = await buildCardFile();
          const url = URL.createObjectURL(card);
          const w = window.open('about:blank','_blank');
          if(w){ w.document.write(`<p style=\"font-family:system-ui,Arial\">Salve a imagem e anexe no WhatsApp:</p><img src=\"${url}\" style=\"max-width:100%;height:auto;border:1px solid #ddd;border-radius:8px\">`); w.document.close(); }
        }catch(e){ console.warn('Falha no fallback do card', e); }
      }
      openWhatsWithText(text, fone.value);
    });
  </script>
</body>
</html>
