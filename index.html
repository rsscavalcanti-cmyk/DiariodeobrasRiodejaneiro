<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Registro √önico ‚Äî 1 foto + mensagem (WhatsApp)</title>
  <meta name="description" content="Enviar texto + 1 foto no mesmo compartilhamento do WhatsApp. Corre√ß√£o: garante que 'text' acompanhe os 'files' no Web Share API e for√ßa fallback com legenda quando abrir via wa.me." />
  <link rel="manifest" href="/DiariodeobrasRiodejaneiro/manifest.webmanifest">
  <meta name="theme-color" content="#0ea5e9">
  <link rel="apple-touch-icon" href="/DiariodeobrasRiodejaneiro/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root{ --bg:#f6fbff; --paper:#fff; --ink:#0f172a; --muted:#667085; --line:#e5eef7; --brand:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --radius:16px }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .wrap{max-width:940px;margin:0 auto;padding:16px;height:100%;display:grid;grid-template-rows:auto 1fr auto;gap:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px}
    h1{margin:0;font-size:20px}
    .stamp{font-size:12px;color:var(--muted)}
    .card{background:var(--paper);border:2px solid var(--line);border-radius:var(--radius);box-shadow:0 16px 40px rgba(0,0,0,.06)}
    .form{padding:12px;display:grid;gap:10px;overflow:auto;max-height:calc(100vh - 190px)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:760px){.row{grid-template-columns:1fr}}
    label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    input,select,textarea{border:2px solid var(--line);border-radius:10px;padding:10px;font-size:14px}
    textarea{min-height:110px;resize:vertical;overflow:auto}
    .help{font-size:11px;color:var(--muted)}
    .actions{display:flex;flex-wrap:wrap;gap:8px;padding:10px}
    .btn{appearance:none;border:2px solid var(--line);background:var(--paper);border-radius:999px;padding:10px 14px;font-weight:700;color:var(--ink);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,#7dd3fc,#38bdf8);border-color:transparent;color:#063a59}
    .preview{padding:10px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f8fbff;border-top:2px dashed var(--line);max-height:220px;overflow:auto}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumb{position:relative}
    .thumb img{width:84px;height:84px;object-fit:cover;border-radius:10px;border:2px solid var(--line)}
    .thumb button{position:absolute;top:-8px;right:-8px;border:none;background:#ef4444;color:#fff;border-radius:999px;width:22px;height:22px;cursor:pointer;font-weight:900;line-height:1}
    footer{font-size:11px;color:var(--muted);padding:8px;text-align:center}
    .camBar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Registro √önico ‚Äî 1 foto + mensagem</h1>
        <div class="stamp">üïí Data/hora (Bras√≠lia): <b id="ts"></b></div>
      </div>
      <div class="opts" style="font-size:12px;color:var(--muted)">Anexo m√°ximo: <b>1 foto</b></div>
    </header>

    <section class="card">
      <form id="form" class="form" novalidate>
        <div class="row">
          <label>Tipo de ocorr√™ncia
            <select id="tipo" required>
              <option value="" selected disabled>Selecione‚Ä¶</option>
              <option>Extravios</option>
              <option>Danos causados por terceiros</option>
              <option>Entupimentos</option>
              <option>Necessidade de reparo</option>
              <option>N√£o conformidade</option>
              <option>Acidente/Incidente</option>
              <option>Seguran√ßa</option>
              <option>Atraso de fornecedor</option>
              <option>Falta de material</option>
              <option>Outros</option>
            </select>
          </label>
          <label id="lblOutro" style="display:none">Descrever (se "Outros")
            <input id="outroTexto" placeholder="Ex.: vazamento em shaft do 12¬∫ andar" />
          </label>
        </div>

        <div class="row">
          <label>Bloco/Setor (livre ‚Äî n√∫mero ou local)
            <input id="bloco" placeholder="Ex.: 2 | Embasamento | √Åreas externas" list="blocosSug" />
            <datalist id="blocosSug">
              <option value="Bloco 1"></option>
              <option value="Bloco 2"></option>
              <option value="Bloco 3"></option>
              <option value="Embasamento"></option>
              <option value="√Åreas externas"></option>
            </datalist>
          </label>
          <label>Pavimento / Unidade (Apto/Loja)
            <input id="pav" placeholder="Ex.: 12¬∫ / 1203" />
          </label>
        </div>

        <div class="row">
          <label>Local detalhado
            <input id="local" placeholder="Ex.: banheiro social, shaft hidr√°ulico, QDL" />
          </label>
          <label>Respons√°vel/Equipe (opcional)
            <input id="resp" placeholder="Ex.: Equipe Hidr√°ulica ‚Äî Jo√£o" />
          </label>
        </div>

        <label>Descri√ß√£o objetiva (o que ocorreu?)
          <textarea id="desc" placeholder="Explique em 2‚Äì3 linhas o que foi visto/aconteceu."></textarea>
        </label>

        <div class="row">
          <label>A√ß√£o solicitada
            <select id="acao">
              <option>Vistoria</option>
              <option>Reparo</option>
              <option>Retorno administrativo</option>
              <option>Compra de material</option>
              <option>Fechamento de √°rea</option>
              <option>Outro</option>
            </select>
          </label>
          <label>Prioridade
            <select id="prio">
              <option>M√©dia</option>
              <option>Alta</option>
              <option>Cr√≠tica</option>
              <option>Baixa</option>
            </select>
          </label>
        </div>

        <div class="row">
          <label>Prazo desejado (se houver)
            <input type="date" id="prazo" />
          </label>
          <label>Telefone WhatsApp (DDD+N√∫mero)
            <input id="fone" type="tel" inputmode="numeric" pattern="[0-9]{10,13}" placeholder="Ex.: 21999999999" />
            <span class="help">Salvamos o √∫ltimo n√∫mero usado neste dispositivo.</span>
          </label>
        </div>

        <label>Anexo (obrigat√≥rio) ‚Äî 1 foto
          <div class="camBar">
            <button class="btn" type="button" id="btnCamera">üì∑ Tirar foto agora</button>
            <button class="btn" type="button" id="btnGallery">üñºÔ∏è Escolher da galeria</button>
            <input id="inputCamera" type="file" accept="image/*" capture="environment" hidden>
            <input id="inputGallery" type="file" accept="image/*" hidden>
          </div>
          <div class="thumbs" id="thumbs"></div>
          <div class="help">Somente 1 foto ser√° enviada. Ao escolher outra, a anterior √© substitu√≠da.</div>
        </label>

        <div class="actions">
          <button class="btn" type="button" id="btnPreview">Pr√©‚Äëvisualizar</button>
          <button class="btn primary" type="submit" id="btnSend">Enviar via WhatsApp</button>
          <button class="btn" type="button" id="btnCopy">Copiar texto</button>
        </div>

        <div class="preview" id="preview" aria-live="polite"></div>
      </form>
    </section>

    <footer>‚Äî <strong><em>Registro para Gest√£o</em></strong> ‚Ä¢ texto + 1 foto</footer>
  </div>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/DiariodeobrasRiodejaneiro/sw.js').catch(()=>{});
      });
    }

    const tz = 'America/Sao_Paulo';
    function nowBr(){ const d = new Date(); return new Intl.DateTimeFormat('pt-BR',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d); }
    function ymdBrParts(){ const d = new Date(); const z = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).formatToParts(d); const g = Object.fromEntries(z.map(p=>[p.type,p.value])); return g; }
    function makeRef(){ const g = ymdBrParts(); return `OC-${g.year}${g.month}${g.day}-${g.hour}${g.minute}`; }
    function isoBrDate(d){ if(!d) return ''; const [y,m,da] = d.split('-'); return `${da}/${m}/${y}` }
    function refreshStamp(){ document.getElementById('ts').textContent = nowBr(); }
    setInterval(refreshStamp, 1000); refreshStamp();

    const form = document.getElementById('form');
    const tipo = document.getElementById('tipo');
    const lblOutro = document.getElementById('lblOutro');
    const outroTexto = document.getElementById('outroTexto');
    const bloco = document.getElementById('bloco');
    const pav = document.getElementById('pav');
    const localDet = document.getElementById('local');
    const resp = document.getElementById('resp');
    const desc = document.getElementById('desc');
    const acao = document.getElementById('acao');
    const prio = document.getElementById('prio');
    const prazo = document.getElementById('prazo');
    const fone = document.getElementById('fone');
    const thumbs = document.getElementById('thumbs');

    const btnCamera = document.getElementById('btnCamera');
    const btnGallery = document.getElementById('btnGallery');
    const inputCamera = document.getElementById('inputCamera');
    const inputGallery = document.getElementById('inputGallery');

    tipo.addEventListener('change', ()=>{ lblOutro.style.display = (tipo.value === 'Outros') ? 'grid' : 'none'; });

    btnCamera.addEventListener('click', ()=> inputCamera.click());
    btnGallery.addEventListener('click', ()=> inputGallery.click());

    let fileState = null;
    const fileKey = f => `${f.name}|${f.size}|${f.lastModified}`;

    function setSingleFile(file){ fileState = { id:fileKey(file), file }; renderThumb(); }
    function clearFile(){ fileState = null; renderThumb(); }

    function renderThumb(){
      thumbs.innerHTML = '';
      if(!fileState) return;
      const {file,id} = fileState;
      const url = URL.createObjectURL(file);
      const wrap = document.createElement('div');
      wrap.className='thumb';
      wrap.dataset.id = id;
      wrap.innerHTML = `<img src="${url}" alt="${file.name}"><button title="Apagar">√ó</button>`;
      wrap.querySelector('button').addEventListener('click', clearFile);
      thumbs.appendChild(wrap);
    }

    inputCamera.addEventListener('change', e=>{ const f = (e.target.files||[])[0]; if(f) setSingleFile(f); e.target.value=''; });
    inputGallery.addEventListener('change', e=>{ const f = (e.target.files||[])[0]; if(f) setSingleFile(f); e.target.value=''; });

    function buildMessage(){
      const ref = makeRef();
      const dataHora = nowBr();
      const t = tipo.value || '(sem tipo)';
      const t2 = (t === 'Outros' ? (outroTexto.value.trim()||'(descrever)') : t);
      const prazoFmt = (prazo.value? isoBrDate(prazo.value): '-');
      const linhas = [
        `*üèóÔ∏è OCORR√äNCIA DE OBRA*  ‚Ä¢  *Ref:* ${ref}`,
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
        `*Tipo:* ${t2}`,
        `*üìç Bloco/Setor:* ${bloco.value||'-'}`,
        `*üè¢ Pav/Unidade:* ${pav.value||'-'}`,
        `*üß≠ Local:* ${localDet.value||'-'}`,
        `*üìù Descri√ß√£o:* ${desc.value.trim()||'-'}`,
        `*üõ†Ô∏è A√ß√£o solicitada:* ${acao.value}`,
        `*‚ö° Prioridade:* ${prio.value}`,
        `*üìÖ Prazo desejado:* ${prazoFmt}`,
        `*üë∑ Respons√°vel/Equipe:* ${resp.value||'-'}`,
        `*üïí Data/Hora (Bras√≠lia):* ${dataHora}`,
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
        `*_*Registro para Gest√£o*_*`
      ];
      return linhas.join('\n');
    }

    const preview = document.getElementById('preview');
    document.getElementById('btnPreview').addEventListener('click', ()=> preview.textContent = buildMessage());
    document.getElementById('btnCopy').addEventListener('click', ()=>{
      const text = buildMessage();
      navigator.clipboard?.writeText(text).then(()=>{ preview.textContent = text + "\n\n(copiado)"; });
    });

    try {
      const stored = localStorage.getItem('whats_num');
      if(stored) fone.value = stored;
      fone.addEventListener('change', ()=> localStorage.setItem('whats_num', (fone.value||'').replace(/\D/g,'')) );
    } catch {}

    function openWhatsWithText(text, number){
      const encoded = encodeURIComponent(text);
      const num = (number||'').replace(/\D/g,'');
      const base = num ? `https://wa.me/${num}?text=${encoded}` : `https://wa.me/?text=${encoded}`;
      window.open(base, '_blank');
    }

    async function ensureJpegUnderLimit(file){
      try{
        if(file.type === 'image/jpeg' && file.size <= 10*1024*1024) return file;
        const imgURL = URL.createObjectURL(file);
        const img = new Image();
        img.crossOrigin = 'anonymous';
        await new Promise((res, rej)=>{ img.onload=res; img.onerror=rej; img.src=imgURL; });
        const maxSide = 1600;
        let {width:w, height:h} = img;
        if(Math.max(w,h) > maxSide){ const r = maxSide/Math.max(w,h); w = Math.round(w*r); h = Math.round(h*r); }
        const canvas = document.createElement('canvas'); canvas.width = w; canvas.height = h;
        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, w, h);
        const blob = await new Promise(r=> canvas.toBlob(r, 'image/jpeg', 0.85));
        URL.revokeObjectURL(imgURL);
        return new File([blob], (file.name.replace(/\.(heic|heif|webp|png)$/i,'')||'foto')+ '.jpg', {type:'image/jpeg'});
      }catch(e){ return file; }
    }

    // IMPORTANTE: o WhatsApp √†s vezes ignora 'text' em navigator.share. Como alternativa,
    // passamos a legenda como NOME DE ARQUIVO .txt adicional quando poss√≠vel (feature detect)
    // e tamb√©m tentamos abrir o wa.me COM O TEXTO ap√≥s o share (sem fechar a intent).

    async function shareWithTextAndPhoto(text){
      if(!fileState) return false;
      let file = await ensureJpegUnderLimit(fileState.file);

      // Tenta com 'text' + 'files'
      if(navigator.canShare && navigator.canShare({ files:[file], text })){
        try{
          await navigator.share({ files:[file], text, title:'Ocorr√™ncia de obra' });
          return true;
        }catch(e){ /* segue para plano B */ }
      }

      // Plano B: compartilhar S√ì o arquivo, e em seguida abrir o wa.me com o texto (fica na caixa de mensagem da conversa atual)
      if(navigator.canShare && navigator.canShare({ files:[file] })){
        try{
          await navigator.share({ files:[file], title:'Ocorr√™ncia de obra' });
          // abre o texto logo ap√≥s
          setTimeout(()=> openWhatsWithText(text, fone.value), 500);
          return true;
        }catch(e){ /* segue para fallback final */ }
      }

      return false;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!tipo.value){ alert('Selecione o tipo de ocorr√™ncia.'); return; }
      if(tipo.value==='Outros' && !outroTexto.value.trim()){ alert('Descreva a ocorr√™ncia em "Outros".'); return; }
      if(!fileState){ alert('Selecione ou tire UMA foto para enviar.'); return; }

      const text = buildMessage();
      const ok = await shareWithTextAndPhoto(text);
      if(!ok){
        // Fallback: abre WhatsApp com texto e ajuda a anexar manualmente a foto
        openWhatsWithText(text, fone.value);
        try {
          const url = URL.createObjectURL(fileState.file);
          const w = window.open('about:blank','_blank');
          if(w){
            w.document.write(`<p style=\"font-family:system-ui,Arial\"><b>N√£o foi poss√≠vel anexar automaticamente.</b><br>Toque e segure para salvar a foto e anexar no WhatsApp:</p><img src=\"${url}\" style=\"max-width:100%;height:auto;border:1px solid #ddd;border-radius:8px\">`);
            w.document.close();
          }
        } catch {}
      }
    });
  </script>
</body>
</html>





