<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Obra ‚Äî Tarefas</title>
  <meta name="description" content="Controle de tarefas de obra com fotos, relat√≥rio, compartilhamento e exclus√£o de tarefas/fotos." />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="manifest" href="./manifest.webmanifest">
  <style>
    :root{ --bg:#f6fbff; --paper:#fff; --ink:#0f172a; --muted:#667085; --line:#e5eef7; --brand:#0ea5e9; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --radius:16px }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    h1,h2{margin:0}
    .app{max-width:1100px;margin:0 auto;padding:16px 14px 56px}
    header{display:grid;grid-template-columns:1fr auto;gap:12px;align-items:center;margin-bottom:12px}
    .controls{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:2px solid var(--line);background:var(--paper);border-radius:999px;padding:10px 14px;font-weight:700;color:var(--ink);box-shadow:0 6px 18px rgba(0,0,0,.06);cursor:pointer}
    .btn.primary{background:linear-gradient(180deg,#7dd3fc,#38bdf8);border-color:transparent;color:#063a59}
    .btn.danger{background:#fff0f0;border:2px solid #fecaca;color:#7f1d1d}
    .btn.icon{padding:8px 10px;border-radius:12px}
    .btn:active{transform:translateY(1px)}

    .filters{display:flex;gap:8px;flex-wrap:wrap}
    select,input[type="date"],input[type="text"]{border:2px solid var(--line);border-radius:10px;padding:8px 10px}

    .grid{display:grid;grid-template-columns:2fr 1fr;gap:14px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}

    .card{background:var(--paper);border:2px solid var(--line);border-radius:var(--radius);padding:12px;box-shadow:0 18px 40px rgba(0,0,0,.06)}

    .task{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center;padding:10px;border:2px solid var(--line);border-radius:14px;background:linear-gradient(180deg,#fff,#f7fbff)}
    .task + .task{margin-top:10px}
    .status{padding:4px 8px;border-radius:999px;font-weight:800}
    .st-todo{background:#fff;border:2px solid var(--line)}
    .st-doing{background:#fff3d1;border:2px solid #fde68a}
    .st-done{background:#dcfce7;border:2px solid #86efac}

    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:900px){.kpis{grid-template-columns:1fr}}
    .kpi{background:#fff;border:2px solid var(--line);border-radius:12px;padding:12px;text-align:center}
    .kpi b{display:block;font-size:24px}

    .right .card{position:sticky;top:12px}
    textarea{width:100%;min-height:90px;padding:10px;border-radius:10px;border:2px solid var(--line)}

    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumb{position:relative}
    .thumb img{width:70px;height:70px;border-radius:10px;border:2px solid var(--line);object-fit:cover;display:block}
    .thumb button.rm{position:absolute;top:-8px;right:-8px;border:none;background:#ef4444;color:#fff;border-radius:999px;width:22px;height:22px;cursor:pointer;font-weight:900;line-height:1}

    .muted{color:var(--muted);font-size:12px}
    footer{position:fixed;left:0;right:0;bottom:0;padding:8px 14px;text-align:center;font-size:11px;color:#556987;background:#ffffffcc;border-top:1px solid var(--line);backdrop-filter:saturate(140%) blur(6px)}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div>
        <h1>Obra ‚Äî Tarefas</h1>
      </div>
      <div class="controls">
        <button class="btn primary" id="btnAdd">+ Nova</button>
        <button class="btn" id="btnReport">Relat√≥rio</button>
        <button class="btn" id="btnSharePhotos">Fotos + relat√≥rio</button>
        <button class="btn" id="btnExport">Exportar</button>
        <input type="file" id="importFile" accept="application/json" hidden>
        <button class="btn" id="btnImport">Importar</button>
      </div>
    </header>

    <div class="card filters" style="margin-bottom:12px">
      <select id="filterDisc">
        <option value="">Disciplinas</option>
        <option>El√©trica</option>
        <option>Hidr√°ulica</option>
        <option>Inc√™ndio</option>
        <option>G√°s</option>
      </select>
      <select id="filterStatus">
        <option value="">Status</option>
        <option value="todo">A fazer</option>
        <option value="doing">Em execu√ß√£o</option>
        <option value="done">Conclu√≠da</option>
      </select>
      <input id="filterSearch" type="text" placeholder="Buscar">
      <input id="filterDate" type="date" title="Prazo at√©">
    </div>

    <div class="grid">
      <section class="card left">
        <div class="kpis" id="kpis"></div>
        <div id="list"></div>
      </section>

      <aside class="right">
        <div class="card">
          <h2>Relat√≥rio</h2>
          <textarea id="reportBox" placeholder="Gerar relat√≥rio"></textarea>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
            <button class="btn" id="btnCopy">Copiar</button>
            <button class="btn" id="btnShare">Compartilhar</button>
          </div>
          <hr style="border:none;border-top:2px solid var(--line);margin:12px 0">
          <h2>Bloqueios</h2>
          <ul id="blocks" class="muted"></ul>
        </div>
      </aside>
    </div>
  </div>

  <!-- Modal de tarefa -->
  <dialog id="dlg" style="border:none;border-radius:16px;padding:0;">
    <form id="taskForm" novalidate style="padding:14px;min-width:300px;max-width:560px">
      <h2 id="dlgTitle">Nova tarefa</h2>
      <div style="display:grid;gap:8px;margin-top:8px">
        <input id="fTitulo" placeholder="T√≠tulo" required>
        <select id="fDisc">
          <option>El√©trica</option><option>Hidr√°ulica</option><option>Inc√™ndio</option><option>G√°s</option>
        </select>
        <input id="fResp" placeholder="Respons√°vel">
        <input id="fPrazo" type="date" placeholder="Prazo">
        <label>Progresso: <span id="progVal">0</span>%</label>
        <input id="fProg" type="range" min="0" max="100" value="0" oninput="progVal.textContent=this.value">
        <select id="fStatus">
          <option value="todo">A fazer</option>
          <option value="doing">Em execu√ß√£o</option>
          <option value="done">Conclu√≠da</option>
        </select>
        <textarea id="fNotas" placeholder="Notas"></textarea>
        <textarea id="fBlock" placeholder="Bloqueio"></textarea>
        <label>Fotos: <input type="file" id="fFotos" accept="image/*" multiple capture="environment"></label>
        <div class="thumbs" id="fThumbs"></div>
      </div>
      <div style="display:flex;gap:8px;justify-content:space-between;margin-top:12px;flex-wrap:wrap">
        <button class="btn danger" type="button" id="btnDeleteTask" style="display:none">Excluir tarefa</button>
        <div style="display:flex;gap:8px">
          <button class="btn" type="button" id="btnCancel">Cancelar</button>
          <button class="btn primary" id="btnSave" type="submit">Salvar</button>
        </div>
      </div>
    </form>
  </dialog>

  <footer>
    Desenvolvido por <strong>Renato Stofel Cavalcanti</strong>
  </footer>

  <script>
    /* ===================== Armazenamento ===================== */
    const KEY='obra-app-final';
    const db = { tasks: [], seq: 1 };
    const load=()=>{ try{ return JSON.parse(localStorage.getItem(KEY))||db }catch(_){ return db } };
    const save=(state)=>localStorage.setItem(KEY, JSON.stringify(state));
    let state = load();

    /* ===================== Utilidades ===================== */
    const $=sel=>document.querySelector(sel);
    const $$=sel=>Array.from(document.querySelectorAll(sel));
    const pad=n=>String(n).padStart(2,'0');
    const todayStr=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`};
    const toDataUrlFile=(dataUrl, name='foto.jpg')=>{ const [hdr,b64]=dataUrl.split(','); const mime=(hdr.match(/data:(.*?);/)||[])[1]||'image/jpeg'; const bin=atob(b64||''); const len=bin.length; const bytes=new Uint8Array(len); for(let i=0;i<len;i++){bytes[i]=bin.charCodeAt(i)}; return new File([bytes], name, {type:mime}); };

    function uid(){ return 't'+(state.seq++) }
    function photoFilesToDataURLs(files){ return Promise.all(Array.from(files).map(f=>new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(f) })))}

    /* ========== Render ========= */
    const listEl = $('#list');
    const kpisEl = $('#kpis');
    const blocksEl = $('#blocks');

    function currentFiltered(){
      const disc = $('#filterDisc').value; const st = $('#filterStatus').value; const txt = $('#filterSearch').value.toLowerCase(); const dt = $('#filterDate').value;
      return state.tasks.filter(t=>
        (!disc || t.disc===disc) && (!st || t.status===st) && (!dt || (t.due && t.due<=dt)) &&
        (!txt || (t.title.toLowerCase().includes(txt) || (t.owner||'').toLowerCase().includes(txt)))
      ).sort((a,b)=> (a.due||'9999').localeCompare(b.due||'9999'));
    }

    function kpis(){
      const total = state.tasks.length;
      const done = state.tasks.filter(t=>t.status==='done').length;
      const doing = state.tasks.filter(t=>t.status==='doing').length;
      kpisEl.innerHTML = `
        <div class="kpi"><div>Total</div><b>${total}</b></div>
        <div class="kpi"><div>Conclu√≠das</div><b>${done}</b></div>
        <div class="kpi"><div>Execu√ß√£o</div><b>${doing}</b></div>`;
      const bs = state.tasks.filter(t=>t.block && !t.block_done).map(t=>`<li>‚Ä¢ <b>${t.title}</b> ‚Äî ${t.block}</li>`);
      blocksEl.innerHTML = bs.join('') || '<li>‚Äî</li>';
    }

    function render(){
      kpis();
      const tasks = currentFiltered();
      listEl.innerHTML='';
      tasks.forEach(t=>{
        const row=document.createElement('div'); row.className='task';
        const stClass = t.status==='done'?'st-done': t.status==='doing'?'st-doing':'st-todo';
        const left = document.createElement('div'); left.innerHTML = `<div class="status ${stClass}">${t.status==='done'?'Conclu√≠da':t.status==='doing'?'Em execu√ß√£o':'A fazer'}</div>`;
        const mid = document.createElement('div');
        const due = t.due? `‚Ä¢ ${t.due}`:'';
        const own = t.owner? `‚Ä¢ ${t.owner}`:'';
        const pics = (t.photos||[]).length?` ‚Ä¢ üì∑ ${t.photos.length}`:'';
        mid.innerHTML = `<b>${t.title}</b><div class="muted">${t.disc} ${due} ${own} ‚Ä¢ ${t.progress||0}%${pics}</div>`;
        const right = document.createElement('div'); right.style.display='grid'; right.style.gap='6px'; right.style.justifyItems='end';
        const bEdit = document.createElement('button'); bEdit.className='btn'; bEdit.textContent='Editar'; bEdit.onclick=()=>openEdit(t.id);
        const bDone = document.createElement('button'); bDone.className='btn'; bDone.textContent=t.status==='done'?'‚Ü∫ Reabrir':'‚úì Concluir'; bDone.onclick=()=>{ t.status = t.status==='done'?'doing':'done'; save(state); render(); };
        const bDel  = document.createElement('button'); bDel.className='btn danger icon'; bDel.title='Excluir'; bDel.textContent='üóëÔ∏è'; bDel.onclick=()=>deleteTask(t.id);
        right.append(bEdit,bDone,bDel);
        row.append(left, mid, right);
        listEl.appendChild(row);
      });
    }

    /* ========== Helpers de Foto no formul√°rio ========= */
    const fThumbs=$('#fThumbs');
    function addThumb(url){
      const wrap=document.createElement('div');
      wrap.className='thumb';
      wrap.innerHTML=`<img src="${url}"><button class="rm" title="Remover foto" type="button">√ó</button>`;
      fThumbs.appendChild(wrap);
    }
    function loadThumbs(urls){ fThumbs.innerHTML=''; (urls||[]).forEach(addThumb); }
    fThumbs.addEventListener('click',(e)=>{
      const btn=e.target.closest('button.rm');
      if(btn){ btn.parentElement.remove(); }
    });

    /* ========== CRUD ========= */
    const dlg = $('#dlg');
    const form = $('#taskForm');
    const fTitulo=$('#fTitulo'), fDisc=$('#fDisc'), fResp=$('#fResp'), fPrazo=$('#fPrazo'), fProg=$('#fProg'), fStatus=$('#fStatus'), fNotas=$('#fNotas'), fBlock=$('#fBlock'), fFotos=$('#fFotos');
    const btnDeleteTask=$('#btnDeleteTask');
    let editingId=null;

    function resetForm(){ editingId=null; $('#dlgTitle').textContent='Nova tarefa'; fTitulo.value=''; fDisc.value='El√©trica'; fResp.value=''; fPrazo.value=''; fProg.value=0; progVal.textContent=0; fStatus.value='todo'; fNotas.value=''; fBlock.value=''; fFotos.value=''; loadThumbs([]); btnDeleteTask.style.display='none'; }

    function openNew(){ resetForm(); dlg.showModal(); }

    function openEdit(id){
      const t = state.tasks.find(x=>x.id===id); if(!t) return;
      editingId=id; $('#dlgTitle').textContent='Editar tarefa'; fTitulo.value=t.title; fDisc.value=t.disc; fResp.value=t.owner||''; fPrazo.value=t.due||''; fProg.value=t.progress||0; progVal.textContent=fProg.value; fStatus.value=t.status; fNotas.value=t.notes||''; fBlock.value=t.block||''; loadThumbs(t.photos||[]); btnDeleteTask.style.display='inline-flex'; dlg.showModal();
    }

    function deleteTask(id){
      if(!confirm('Excluir esta tarefa? Esta a√ß√£o n√£o pode ser desfeita.')) return;
      const i=state.tasks.findIndex(t=>t.id===id);
      if(i>-1){ state.tasks.splice(i,1); save(state); render(); }
      if(dlg.open && editingId===id){ dlg.close(); }
    }

    btnDeleteTask.addEventListener('click',()=>{ if(editingId) deleteTask(editingId); });

    // PREVIEW r√°pido ao selecionar (n√£o depende do salvar)
    fFotos.addEventListener('change', async (e)=>{
      const urls = await photoFilesToDataURLs(e.target.files);
      urls.forEach(addThumb);
    });

    async function gatherPhotosForSave(){
      const imgs = Array.from(fThumbs.querySelectorAll('img')).map(i=>i.src);
      // se ainda houver arquivos no input, garante que entram
      const pending = fFotos.files && fFotos.files.length ? await photoFilesToDataURLs(fFotos.files) : [];
      return [...imgs, ...pending];
    }

    // SUBMIT do formul√°rio
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const photos = await gatherPhotosForSave();
      const obj = { id: editingId||uid(), title:fTitulo.value.trim(), disc:fDisc.value, owner:fResp.value.trim(), due:fPrazo.value||null, progress:+fProg.value, status:fStatus.value, notes:fNotas.value.trim(), block:fBlock.value.trim(), block_done:false, photos };
      if(!obj.title){ alert('T√≠tulo obrigat√≥rio'); return; }
      if(editingId){ const i=state.tasks.findIndex(t=>t.id===editingId); state.tasks[i]=obj; }
      else{ state.tasks.push(obj); }
      save(state); dlg.close(); render();
    });

    $('#btnCancel').addEventListener('click', ()=> dlg.close());
    $('#btnAdd').onclick=openNew;

    /* ========== Filtros, relat√≥rio e I/O ========= */
    $$('#filterDisc, #filterStatus, #filterDate').forEach(el=> el.addEventListener('change', render));
    $('#filterSearch').addEventListener('input', render);

    function report(tasks){
      const d=new Date(); const head=`Relat√≥rio ‚Äî ${d.toLocaleDateString()}\n`+"-".repeat(18)+"\n";
      const parts = tasks.map(t=>{
        const p1 = `‚Ä¢ ${t.title} [${t.disc}] ‚Äî ${t.progress||0}% ‚Äî ${t.status}`;
        const p2 = [t.owner||'', t.due||''].filter(Boolean).join(' | ');
        const p3 = t.block?`\n  BLOQUEIO: ${t.block}`:'';
        const p4 = (t.photos||[]).length?`\n  fotos: ${t.photos.length}`:'';
        return p1 + (p2?`\n  ${p2}`:'') + (t.notes?`\n  notas: ${t.notes}`:'') + p3 + p4;
      }).join('\n');
      return head+parts;
    }

    $('#btnReport').onclick=()=>{ $('#reportBox').value=report(currentFiltered()); };
    $('#btnCopy').onclick=()=>{ const ta=$('#reportBox'); ta.select(); document.execCommand('copy'); };
    $('#btnShare').onclick=async()=>{
      const text = $('#reportBox').value || report(currentFiltered());
      if(navigator.share){ try{ await navigator.share({text}); }catch(_){} }
      else{ $('#reportBox').value=text; alert('Relat√≥rio pronto. Copie e cole.'); }
    };

    async function shareWithPhotos(){
      const tasks = currentFiltered();
      const text = report(tasks);
      const photos = tasks.flatMap(t=> (t.photos||[]));
      if(!photos.length){ alert('Sem fotos nas tarefas filtradas.'); return; }
      const MAX = 20;
      const files = photos.slice(0, MAX).map((d,i)=> toDataUrlFile(d, `obra_${i+1}.jpg`));
      if(navigator.canShare && navigator.canShare({files})){
        try{ await navigator.share({ files, text, title: 'Relat√≥rio da obra' }); }catch(e){}
      }else{
        const w = window.open('', '_blank');
        const imgs = photos.map(src=>`<img src="${src}" style="max-width:140px;margin:6px;border:1px solid #ddd;border-radius:8px">`).join('');
        w.document.write(`<pre>${text.replace(/</g,'&lt;')}</pre><div>${imgs}</div>`);
        w.document.close();
      }
    }
    $('#btnSharePhotos').onclick = shareWithPhotos;

    $('#btnExport').onclick=()=>{ const a=document.createElement('a'); const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'}); a.href=URL.createObjectURL(blob); a.download='obra-dados.json'; a.click(); };
    $('#btnImport').onclick=()=> $('#importFile').click();
    $('#importFile').addEventListener('change', async (e)=>{ const f=e.target.files?.[0]; if(!f) return; const txt=await f.text(); try{ const obj=JSON.parse(txt); if(obj && Array.isArray(obj.tasks)){ state=obj; save(state); render(); } }catch(_){ alert('JSON inv√°lido'); } });

    /* ========== Boot ========= */
    render();

    /* ===== Service Worker ===== */
    const isSecure = window.isSecureContext && /^(https:)|(^http:\/\/localhost)/.test(location.href);
    const swUrl = (()=>{ const base = location.pathname.replace(/\/[^\/]*$/, '/'); return base + 'sw.js'; })();
    if('serviceWorker' in navigator && isSecure){
      fetch(swUrl,{cache:'no-store'}).then(r=>{ if(r.ok) navigator.serviceWorker.register(swUrl); }).catch(()=>{});
    }

    /* ========== Testes r√°pidos ========= */
    ;(function selfTests(){
      try{
        console.assert(typeof toDataUrlFile === 'function', 'toDataUrlFile dispon√≠vel');
        const tf = document.getElementById('taskForm');
        console.assert(tf instanceof HTMLFormElement, 'form OK');
        console.log('[TEST] OK ‚Äî b√°sicos');
      }catch(e){ console.error('[TEST] Falhou', e); }
    })();
  </script>
</body>
</html>

