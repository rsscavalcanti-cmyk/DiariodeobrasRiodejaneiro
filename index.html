<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Registro √önico ‚Äî Ocorr√™ncias (WhatsApp)</title>
  <meta name="description" content="Registrar UMA ocorr√™ncia por vez e enviar texto + imagem formatada (card) + anexos via WhatsApp quando suportado." />
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{ --bg:#f6fbff; --paper:#fff; --ink:#0f172a; --muted:#667085; --line:#e5eef7; --brand:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --radius:16px }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .wrap{max-width:940px;margin:0 auto;padding:16px;height:100%;display:grid;grid-template-rows:auto 1fr auto;gap:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px}
    h1{margin:0;font-size:20px}
    .stamp{font-size:12px;color:var(--muted)}
    .card{background:var(--paper);border:2px solid var(--line);border-radius:var(--radius);box-shadow:0 16px 40px rgba(0,0,0,.06)}
    .form{padding:12px;display:grid;gap:10px;overflow:auto;max-height:calc(100vh - 190px)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:760px){.row{grid-template-columns:1fr}}
    label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    input,select,textarea{border:2px solid var(--line);border-radius:10px;padding:10px;font-size:14px}
    textarea{min-height:110px;resize:vertical;overflow:auto}
    .help{font-size:11px;color:var(--muted)}
    .actions{display:flex;flex-wrap:wrap;gap:8px;padding:10px}
    .btn{appearance:none;border:2px solid var(--line);background:var(--paper);border-radius:999px;padding:10px 14px;font-weight:700;color:var(--ink);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,#7dd3fc,#38bdf8);border-color:transparent;color:#063a59}
    .preview{padding:10px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f8fbff;border-top:2px dashed var(--line);max-height:220px;overflow:auto}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{width:70px;height:70px;object-fit:cover;border-radius:10px;border:2px solid var(--line)}
    .opts{display:flex;gap:12px;align-items:center}
    footer{font-size:11px;color:var(--muted);padding:8px;text-align:center}
    canvas{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Registro √önico ‚Äî Ocorr√™ncias (WhatsApp)</h1>
        <div class="stamp">üïí Data/hora (Bras√≠lia): <b id="ts"></b></div>
      </div>
      <div class="opts">
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="chkCard" checked> Incluir *card‚Äëimagem* formatado</label>
        <button class="btn" id="btnClear">Limpar</button>
      </div>
    </header>

    <section class="card">
      <form id="form" class="form" novalidate>
        <div class="row">
          <label>Tipo de ocorr√™ncia
            <select id="tipo" required>
              <option value="" selected disabled>Selecione‚Ä¶</option>
              <option>Extravios</option>
              <option>Danos causados por terceiros</option>
              <option>Entupimentos</option>
              <option>Necessidade de reparo</option>
              <option>N√£o conformidade</option>
              <option>Acidente/Incidente</option>
              <option>Seguran√ßa</option>
              <option>Atraso de fornecedor</option>
              <option>Falta de material</option>
              <option>Outros</option>
            </select>
          </label>
          <label id="lblOutro" style="display:none">Descrever (se "Outros")
            <input id="outroTexto" placeholder="Ex.: vazamento em shaft do 12¬∫ andar" />
          </label>
        </div>

        <div class="row">
          <label>Bloco
            <select id="bloco">
              <option>Bloco 1</option>
              <option>Bloco 2</option>
              <option>Bloco 3</option>
              <option>Embasamento</option>
              <option>√Åreas externas</option>
            </select>
          </label>
          <label>Pavimento / Unidade (Apto/Loja)
            <input id="pav" placeholder="Ex.: 12¬∫ / 1203" />
          </label>
        </div>

        <div class="row">
          <label>Local detalhado
            <input id="local" placeholder="Ex.: banheiro social, shaft hidr√°ulico, QDL" />
          </label>
          <label>Respons√°vel/Equipe (opcional)
            <input id="resp" placeholder="Ex.: Equipe Hidr√°ulica ‚Äî Jo√£o" />
          </label>
        </div>

        <label>Descri√ß√£o objetiva (o que ocorreu?)
          <textarea id="desc" placeholder="Explique em 2‚Äì3 linhas o que foi visto/aconteceu."></textarea>
        </label>

        <div class="row">
          <label>A√ß√£o solicitada
            <select id="acao">
              <option>Vistoria</option>
              <option>Reparo</option>
              <option>Retorno administrativo</option>
              <option>Compra de material</option>
              <option>Fechamento de √°rea</option>
              <option>Outro</option>
            </select>
          </label>
          <label>Prioridade
            <select id="prio">
              <option>M√©dia</option>
              <option>Alta</option>
              <option>Cr√≠tica</option>
              <option>Baixa</option>
            </select>
          </label>
        </div>

        <div class="row">
          <label>Prazo desejado (se houver)
            <input type="date" id="prazo" />
          </label>
          <label>Telefone WhatsApp (DDD+N√∫mero)
            <input id="fone" type="tel" inputmode="numeric" pattern="[0-9]{10,13}" placeholder="Ex.: 21999999999" />
            <span class="help">Salvamos o √∫ltimo n√∫mero usado neste dispositivo.</span>
          </label>
        </div>

        <label>Anexos (opcional) ‚Äî fotos/v√≠deos
          <input id="midia" type="file" accept="image/*,video/*" multiple capture="environment" />
          <div class="thumbs" id="thumbs"></div>
          <div class="help">‚ö†Ô∏è Limita√ß√£o do WhatsApp Web: anexos s√≥ v√£o *automaticamente* em aparelhos com suporte ao *Web Share* (Android/iOS modernos). No desktop, enviaremos o texto e abriremos a imagem para voc√™ salvar e anexar manualmente.</div>
        </label>

        <div class="actions">
          <button class="btn" type="button" id="btnPreview">Pr√©‚Äëvisualizar</button>
          <button class="btn primary" type="submit" id="btnSend">Enviar via WhatsApp</button>
          <button class="btn" type="button" id="btnCopy">Copiar texto</button>
        </div>

        <div class="preview" id="preview" aria-live="polite"></div>
      </form>
    </section>

    <footer>‚Äî Registro <strong>para Gest√£o</strong></footer>
  </div>

  <!-- Canvas usado para gerar o card-imagem -->
  <canvas id="cardCanvas" width="1080" height="1350"></canvas>

  <script>
    // ====== Util: data/hora Bras√≠lia ======
    const tz = 'America/Sao_Paulo';
    function nowBr(){
      const d = new Date();
      return new Intl.DateTimeFormat('pt-BR',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d);
    }
    function ymdBrParts(){
      const d = new Date();
      const z = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).formatToParts(d);
      const g = Object.fromEntries(z.map(p=>[p.type,p.value]));
      return g; // {year,month,day,hour,minute}
    }
    function makeRef(){ const g = ymdBrParts(); return `OC-${g.year}${g.month}${g.day}-${g.hour}${g.minute}`; }
    function isoBrDate(d){ if(!d) return ''; const [y,m,da] = d.split('-'); return `${da}/${m}/${y}` }
    function refreshStamp(){ document.getElementById('ts').textContent = nowBr(); }
    setInterval(refreshStamp, 1000); refreshStamp();

    // ====== DOM refs ======
    const form = document.getElementById('form');
    const tipo = document.getElementById('tipo');
    const lblOutro = document.getElementById('lblOutro');
    const outroTexto = document.getElementById('outroTexto');
    const bloco = document.getElementById('bloco');
    const pav = document.getElementById('pav');
    const localDet = document.getElementById('local');
    const resp = document.getElementById('resp');
    const desc = document.getElementById('desc');
    const acao = document.getElementById('acao');
    const prio = document.getElementById('prio');
    const prazo = document.getElementById('prazo');
    const fone = document.getElementById('fone');
    const midia = document.getElementById('midia');
    const thumbs = document.getElementById('thumbs');
    const preview = document.getElementById('preview');
    const chkCard = document.getElementById('chkCard');
    const canvas = document.getElementById('cardCanvas');

    // ====== Persist√™ncia do √∫ltimo n√∫mero ======
    const KEY_FONE = 'whats-fone-default';
    fone.value = localStorage.getItem(KEY_FONE) || '';
    fone.addEventListener('change', ()=> localStorage.setItem(KEY_FONE, (fone.value||'').replace(/\D/g,'')));

    // ====== UI din√¢mica ======
    tipo.addEventListener('change', ()=>{ lblOutro.style.display = (tipo.value === 'Outros') ? '' : 'none'; });
    midia.addEventListener('change', (e)=>{
      thumbs.innerHTML = '';
      const files = Array.from(e.target.files||[]).slice(0, 20);
      for(const f of files){ const url = URL.createObjectURL(f); const img = document.createElement('img'); img.src = url; img.alt = f.name; thumbs.appendChild(img); }
    });

    // ====== Template do texto para WhatsApp ======
    function buildMessage(){
      const ref = makeRef();
      const dataHora = nowBr();
      const t = tipo.value || '(sem tipo)';
      const t2 = (t === 'Outros' ? (outroTexto.value.trim()||'(descrever)') : t);
      const prazoFmt = (prazo.value? isoBrDate(prazo.value): '-');
      const anexos = (midia.files||[]).length;
      const linhas = [
        `*üèóÔ∏è OCORR√äNCIA DE OBRA*  ‚Ä¢  *Ref:* ${ref}`,
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
        `*Tipo:* ${t2}`,
        `*üìç Bloco/Setor:* ${bloco.value}`,
        `*üè¢ Pav/Unidade:* ${pav.value||'-'}`,
        `*üß≠ Local:* ${localDet.value||'-'}`,
        `*üìù Descri√ß√£o:* ${desc.value.trim()||'-'}`,
        `*üõ†Ô∏è A√ß√£o solicitada:* ${acao.value}`,
        `*‚ö° Prioridade:* ${prio.value}`,
        `*üìÖ Prazo desejado:* ${prazoFmt}`,
        `*üë∑ Respons√°vel/Equipe:* ${resp.value||'-'}`,
        `*üïí Data/Hora (Bras√≠lia):* ${dataHora}`,
        anexos? `*üìé Anexos:* ${anexos} arquivo(s)` : null,
        `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
        `_‚Äî Desenvolvido por Renato Stofel Cavalcanti_`
      ].filter(Boolean);
      return linhas.join('\n');
    }

    function updatePreview(){ preview.textContent = buildMessage(); }
    document.getElementById('btnPreview').addEventListener('click', updatePreview);

    document.getElementById('btnCopy').addEventListener('click', ()=>{
      const text = buildMessage();
      navigator.clipboard?.writeText(text).then(()=>{ preview.textContent = text + "\n\n(copiado para a √°rea de transfer√™ncia)"; });
    });

    document.getElementById('btnClear').addEventListener('click', ()=>{ form.reset(); thumbs.innerHTML=''; updatePreview(); tipo.dispatchEvent(new Event('change')); });

    // ====== Gera√ß√£o do CARD (imagem) ======
    function wrapText(ctx, text, x, y, maxW, lineH){
      const words = text.split(/\s+/); let line = ''; let yy = y; const lines=[];
      for(let i=0;i<words.length;i++){
        const test = line + words[i] + ' ';
        if(ctx.measureText(test).width > maxW && i>0){ lines.push(line.trim()); line = words[i] + ' '; yy+=lineH; }
        else{ line = test; }
      }
      lines.push(line.trim());
      lines.forEach((ln, idx)=> ctx.fillText(ln, x, y + idx*lineH));
      return y + (lines.length-1)*lineH;
    }

    async function buildCardFile(){
      // Config do card
      const W=1080, H=1350, P=64; // 4:5 portrait
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,W,H);
      // Fundo gradiente
      const g = ctx.createLinearGradient(0,0,0,H);
      g.addColorStop(0,'#eaf6ff'); g.addColorStop(1,'#ffffff');
      ctx.fillStyle=g; ctx.fillRect(0,0,W,H);

      // Title bar
      ctx.fillStyle='#0f172a';
      ctx.font='bold 48px Inter, Arial';
      ctx.fillText('OCORR√äNCIA DE OBRA', P, P+8);

      // Subinfo
      const ref = makeRef();
      ctx.font='bold 28px Inter, Arial';
      ctx.fillStyle='#0ea5e9';
      ctx.fillText(`Ref: ${ref}`, P, P+54);

      // Caixa
      const boxY = P+90; const boxH = H - boxY - 180; const boxR = 28;
      // sombra leve
      ctx.fillStyle = '#00000010'; ctx.fillRect(P+6, boxY+6, W-P*2, boxH);
      // caixa branca
      ctx.fillStyle = '#ffffff'; ctx.strokeStyle = '#e5eef7'; ctx.lineWidth = 4;
      // rounded rect manual
      const bw=W-P*2; const bh=boxH; const x=P, y=boxY, r=boxR;
      ctx.beginPath();
      ctx.moveTo(x+r,y); ctx.lineTo(x+bw-r,y); ctx.quadraticCurveTo(x+bw,y,x+bw,y+r);
      ctx.lineTo(x+bw,y+bh-r); ctx.quadraticCurveTo(x+bw,y+bh,x+bw-r,y+bh);
      ctx.lineTo(x+r,y+bh); ctx.quadraticCurveTo(x,y+bh,x,y+bh-r);
      ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y);
      ctx.closePath(); ctx.fill(); ctx.stroke();

      // Texto interno
      ctx.fillStyle='#0f172a';
      ctx.font='600 34px Inter, Arial';
      let yy = y + 56; const lh = 44; const maxW = bw - 40; const xx = x + 20;
      const linhas = [
        `Tipo: ${tipo.value === 'Outros' ? (outroTexto.value.trim()||'(descrever)') : (tipo.value||'(sem tipo)')}`,
        `Bloco/Setor: ${bloco.value}`,
        `Pav/Unidade: ${pav.value||'-'}`,
        `Local: ${localDet.value||'-'}`,
        `Descri√ß√£o:`,
      ];
      linhas.forEach(txt=>{ ctx.fillText(txt, xx, yy); yy += lh; });

      ctx.font='400 30px Inter, Arial';
      yy = wrapText(ctx, (desc.value.trim()||'-'), xx, yy, maxW, 40) + 26;

      ctx.font='600 34px Inter, Arial';
      const extra = [
        `A√ß√£o solicitada: ${acao.value}`,
        `Prioridade: ${prio.value}`,
        `Prazo desejado: ${prazo.value? isoBrDate(prazo.value): '-'}`,
        `Resp./Equipe: ${resp.value||'-'}`,
        `Data/Hora (Bras√≠lia): ${nowBr()}`
      ];
      extra.forEach(t=>{ ctx.fillText(t, xx, yy); yy += lh; });

      // Assinatura
      ctx.font='italic 26px Inter, Arial'; ctx.fillStyle='#64748b';
      ctx.fillText('‚Äî Desenvolvido por Renato Stofel Cavalcanti', P, H-90);

      // Marca d'√°gua leve
      ctx.save(); ctx.translate(W-140, H-70); ctx.rotate(-Math.PI/12);
      ctx.globalAlpha=0.08; ctx.fillStyle='#0ea5e9'; ctx.font='900 90px Inter, Arial'; ctx.fillText('SYSTEM', -200, 0);
      ctx.restore();

      // Gerar File
      const blob = await new Promise(res=> canvas.toBlob(res, 'image/png', 0.92));
      return new File([blob], `ocorrencia_${ref}.png`, {type:'image/png'});
    }

    // ====== Envio para WhatsApp ======
    function openWhatsWithText(text, number){
      const encoded = encodeURIComponent(text);
      const num = (number||'').replace(/\D/g,'');
      const base = num ? `https://wa.me/${num}?text=${encoded}` : `https://wa.me/?text=${encoded}`;
      window.open(base, '_blank');
    }

    async function shareWithFiles(text){
      const files = Array.from(midia.files||[]).slice(0,10);
      const list = [...files];
      if(chkCard.checked){
        try{ const card = await buildCardFile(); list.unshift(card); }catch(e){ console.warn('Falha ao gerar card', e); }
      }
      if(list.length && navigator.canShare && navigator.canShare({ files: list })){
        try{ await navigator.share({ files: list, text, title: 'Ocorr√™ncia de obra' }); return true; }catch(e){ return false; }
      }
      return false;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!tipo.value){ alert('Selecione o tipo de ocorr√™ncia.'); return; }
      if(tipo.value==='Outros' && !outroTexto.value.trim()){ alert('Descreva a ocorr√™ncia em "Outros".'); return; }
      updatePreview();
      const text = buildMessage();

      // 1) Tenta Web Share (mobile) com arquivos (inclui card se ativado)
      const shared = await shareWithFiles(text);
      if(shared) return;

      // 2) Fallback: abre WhatsApp com texto e mostra o card para salvar manualmente (desktop)
      if(chkCard.checked){
        try{
          const card = await buildCardFile();
          const url = URL.createObjectURL(card);
          const w = window.open('about:blank','_blank');
          if(w){ w.document.write(`<p style=\"font-family:system-ui,Arial\">Salve a imagem e anexe no WhatsApp:</p><img src=\"${url}\" style=\"max-width:100%;height:auto;border:1px solid #ddd;border-radius:8px\">`); w.document.close(); }
        }catch(e){ console.warn('Falha no fallback do card', e); }
      }
      openWhatsWithText(text, fone.value);
    });
  </script>
</body>
</html>
