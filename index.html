<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Registro Ãšnico â€” OcorrÃªncias (WhatsApp)</title>
  <meta name="description" content="Registrar UMA ocorrÃªncia por vez e enviar texto + card-imagem + anexos via WhatsApp. Campo 'Bloco/Setor' livre, excluir fotos duplicadas e abertura de cÃ¢mera nativa." />
  <meta name="theme-color" content="#0ea5e9" />
  <style>
    :root{ --bg:#f6fbff; --paper:#fff; --ink:#0f172a; --muted:#667085; --line:#e5eef7; --brand:#0ea5e9; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444; --radius:16px }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .wrap{max-width:940px;margin:0 auto;padding:16px;height:100%;display:grid;grid-template-rows:auto 1fr auto;gap:12px}
    header{display:flex;align-items:center;justify-content:space-between;gap:8px}
    h1{margin:0;font-size:20px}
    .stamp{font-size:12px;color:var(--muted)}
    .card{background:var(--paper);border:2px solid var(--line);border-radius:var(--radius);box-shadow:0 16px 40px rgba(0,0,0,.06)}
    .form{padding:12px;display:grid;gap:10px;overflow:auto;max-height:calc(100vh - 190px)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:760px){.row{grid-template-columns:1fr}}
    label{display:grid;gap:6px;font-size:12px;color:var(--muted)}
    input,select,textarea{border:2px solid var(--line);border-radius:10px;padding:10px;font-size:14px}
    textarea{min-height:110px;resize:vertical;overflow:auto}
    .help{font-size:11px;color:var(--muted)}
    .actions{display:flex;flex-wrap:wrap;gap:8px;padding:10px}
    .btn{appearance:none;border:2px solid var(--line);background:var(--paper);border-radius:999px;padding:10px 14px;font-weight:700;color:var(--ink);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .primary{background:linear-gradient(180deg,#7dd3fc,#38bdf8);border-color:transparent;color:#063a59}
    .preview{padding:10px;white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#f8fbff;border-top:2px dashed var(--line);max-height:220px;overflow:auto}
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumb{position:relative}
    .thumb img{width:70px;height:70px;object-fit:cover;border-radius:10px;border:2px solid var(--line)}
    .thumb button{position:absolute;top:-8px;right:-8px;border:none;background:#ef4444;color:#fff;border-radius:999px;width:22px;height:22px;cursor:pointer;font-weight:900;line-height:1}
    .opts{display:flex;gap:12px;align-items:center}
    footer{font-size:11px;color:var(--muted);padding:8px;text-align:center}
    canvas{display:none}
    /* cÃ¢mera */
    .camBar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Registro Ãšnico â€” OcorrÃªncias (WhatsApp)</h1>
        <div class="stamp">ðŸ•’ Data/hora (BrasÃ­lia): <b id="ts"></b></div>
      </div>
      <div class="opts">
        <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="chkCard" checked> Incluir *cardâ€‘imagem* formatado</label>
        <button class="btn" id="btnClear">Limpar</button>
      </div>
    </header>

    <section class="card">
      <form id="form" class="form" novalidate>
        <div class="row">
          <label>Tipo de ocorrÃªncia
            <select id="tipo" required>
              <option value="" selected disabled>Selecioneâ€¦</option>
              <option>Extravios</option>
              <option>Danos causados por terceiros</option>
              <option>Entupimentos</option>
              <option>Necessidade de reparo</option>
              <option>NÃ£o conformidade</option>
              <option>Acidente/Incidente</option>
              <option>SeguranÃ§a</option>
              <option>Atraso de fornecedor</option>
              <option>Falta de material</option>
              <option>Outros</option>
            </select>
          </label>
          <label id="lblOutro" style="display:none">Descrever (se "Outros")
            <input id="outroTexto" placeholder="Ex.: vazamento em shaft do 12Âº andar" />
          </label>
        </div>

        <div class="row">
          <label>Bloco/Setor (livre â€” nÃºmero ou local)
            <input id="bloco" placeholder="Ex.: 2 | Embasamento | Ãreas externas" list="blocosSug" />
            <datalist id="blocosSug">
              <option value="Bloco 1"></option>
              <option value="Bloco 2"></option>
              <option value="Bloco 3"></option>
              <option value="Embasamento"></option>
              <option value="Ãreas externas"></option>
            </datalist>
          </label>
          <label>Pavimento / Unidade (Apto/Loja)
            <input id="pav" placeholder="Ex.: 12Âº / 1203" />
          </label>
        </div>

        <div class="row">
          <label>Local detalhado
            <input id="local" placeholder="Ex.: banheiro social, shaft hidrÃ¡ulico, QDL" />
          </label>
          <label>ResponsÃ¡vel/Equipe (opcional)
            <input id="resp" placeholder="Ex.: Equipe HidrÃ¡ulica â€” JoÃ£o" />
          </label>
        </div>

        <label>DescriÃ§Ã£o objetiva (o que ocorreu?)
          <textarea id="desc" placeholder="Explique em 2â€“3 linhas o que foi visto/aconteceu."></textarea>
        </label>

        <div class="row">
          <label>AÃ§Ã£o solicitada
            <select id="acao">
              <option>Vistoria</option>
              <option>Reparo</option>
              <option>Retorno administrativo</option>
              <option>Compra de material</option>
              <option>Fechamento de Ã¡rea</option>
              <option>Outro</option>
            </select>
          </label>
          <label>Prioridade
            <select id="prio">
              <option>MÃ©dia</option>
              <option>Alta</option>
              <option>CrÃ­tica</option>
              <option>Baixa</option>
            </select>
          </label>
        </div>

        <div class="row">
          <label>Prazo desejado (se houver)
            <input type="date" id="prazo" />
          </label>
          <label>Telefone WhatsApp (DDD+NÃºmero)
            <input id="fone" type="tel" inputmode="numeric" pattern="[0-9]{10,13}" placeholder="Ex.: 21999999999" />
            <span class="help">Salvamos o Ãºltimo nÃºmero usado neste dispositivo.</span>
          </label>
        </div>

        <label>Anexos (opcional) â€” fotos/vÃ­deos
          <div class="camBar">
            <!-- Abre a cÃ¢mera nativa do aparelho diretamente -->
            <button class="btn" type="button" id="btnNativeCamera">ðŸ“· Abrir cÃ¢mera do aparelho</button>
            <input id="midia" type="file" accept="image/*,video/*" multiple capture="environment" style="display:none" />
          </div>
          <div class="thumbs" id="thumbs"></div>
          <div class="help">Dica: toque e segure em uma miniatura para apagar; o app tambÃ©m filtra duplicadas automaticamente.</div>
        </label>

        <div class="actions">
          <button class="btn" type="button" id="btnPreview">PrÃ©â€‘visualizar</button>
          <button class="btn primary" type="submit" id="btnSend">Enviar via WhatsApp</button>
          <button class="btn" type="button" id="btnCopy">Copiar texto</button>
        </div>

        <div class="preview" id="preview" aria-live="polite"></div>
      </form>
    </section>

    <footer>â€” <strong><em>Registro para GestÃ£o</em></strong></footer>
  </div>

  <!-- Canvas usado para gerar o card-imagem -->
  <canvas id="cardCanvas" width="1080" height="1350"></canvas>

  <script>
    // ====== Util: data/hora BrasÃ­lia ======
    const tz = 'America/Sao_Paulo';
    function nowBr(){ const d = new Date(); return new Intl.DateTimeFormat('pt-BR',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d); }
    function ymdBrParts(){ const d = new Date(); const z = new Intl.DateTimeFormat('en-CA',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}).formatToParts(d); const g = Object.fromEntries(z.map(p=>[p.type,p.value])); return g; }
    function makeRef(){ const g = ymdBrParts(); return `OC-${g.year}${g.month}${g.day}-${g.hour}${g.minute}`; }
    function isoBrDate(d){ if(!d) return ''; const [y,m,da] = d.split('-'); return `${da}/${m}/${y}` }
    function refreshStamp(){ document.getElementById('ts').textContent = nowBr(); }
    setInterval(refreshStamp, 1000); refreshStamp();

    // ====== DOM refs ======
    const form = document.getElementById('form');
    const tipo = document.getElementById('tipo');
    const lblOutro = document.getElementById('lblOutro');
    const outroTexto = document.getElementById('outroTexto');
    const bloco = document.getElementById('bloco');
    const pav = document.getElementById('pav');
    const localDet = document.getElementById('local');
    const resp = document.getElementById('resp');
    const desc = document.getElementById('desc');
    const acao = document.getElementById('acao');
    const prio = document.getElementById('prio');
    const prazo = document.getElementById('prazo');
    const fone = document.getElementById('fone');
    const midia = document.getElementById('midia');
    const thumbs = document.getElementById('thumbs');
    const preview = document.getElementById('preview');
    const chkCard = document.getElementById('chkCard');
    const cardCanvas = document.getElementById('cardCanvas');

    // ====== PersistÃªncia do Ãºltimo nÃºmero ======
    const KEY_FONE = 'whats-fone-default';
    fone.value = localStorage.getItem(KEY_FONE) || '';
    fone.addEventListener('change', ()=> localStorage.setItem(KEY_FONE, (fone.value||'').replace(/\D/g,'')));

    // ====== Estado de anexos (com deduplicaÃ§Ã£o) ======
    let filesState = []; // { id, file, hash }

    // Gera um id estÃ¡vel (nome+tamanho+Ãºltima modificaÃ§Ã£o). Evita dupl.
    function fileKey(f){ return `${f.name}|${f.size}|${f.lastModified}`; }

    function addFiles(list){
      for(const f of list){
        const key = fileKey(f);
        if(filesState.some(x=>x.id===key)) continue; // dedup
        filesState.push({ id:key, file:f });
        addThumb(key, f);
      }
      renderCount();
    }

    function removeFile(id){
      const i = filesState.findIndex(x=>x.id===id);
      if(i>-1){ filesState.splice(i,1); const el = document.querySelector(`[data-id="${id}"]`); el?.remove(); renderCount(); }
    }

    function renderCount(){
      // poderÃ­amos mostrar total se quiser
    }

    function addThumb(id, file){
      const url = URL.createObjectURL(file);
      const wrap = document.createElement('div');
      wrap.className='thumb';
      wrap.dataset.id = id;
      wrap.innerHTML = `<img src="${url}" alt="${file.name}"><button title="Apagar">Ã—</button>`;
      wrap.querySelector('button').addEventListener('click', ()=> removeFile(id));
      // apaga ao segurar 700ms
      let pressT=null; wrap.addEventListener('touchstart',()=>{ pressT=setTimeout(()=>removeFile(id),700); }); wrap.addEventListener('touchend',()=>clearTimeout(pressT));
      thumbs.appendChild(wrap);
    }

    // Input escondido abre a cÃ¢mera nativa (Android/iOS) por causa do capture="environment"
    document.getElementById('btnNativeCamera').addEventListener('click', ()=> midia.click());

    // Quando selecionar via cÃ¢mera/galeria
    midia.addEventListener('change', (e)=>{ const list = Array.from(e.target.files||[]); addFiles(list); midia.value = ''; });

    // ====== Template do texto ======
    function buildMessage(){
      const ref = makeRef();
      const dataHora = nowBr();
      const t = tipo.value || '(sem tipo)';
      const t2 = (t === 'Outros' ? (outroTexto.value.trim()||'(descrever)') : t);
      const prazoFmt = (prazo.value? isoBrDate(prazo.value): '-');
      const anexos = filesState.length + (chkCard.checked?1:0);
      const linhas = [
        `*ðŸ—ï¸ OCORRÃŠNCIA DE OBRA*  â€¢  *Ref:* ${ref}`,
        `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
        `*Tipo:* ${t2}`,
        `*ðŸ“ Bloco/Setor:* ${bloco.value||'-'}`,
        `*ðŸ¢ Pav/Unidade:* ${pav.value||'-'}`,
        `*ðŸ§­ Local:* ${localDet.value||'-'}`,
        `*ðŸ“ DescriÃ§Ã£o:* ${desc.value.trim()||'-'}`,
        `*ðŸ› ï¸ AÃ§Ã£o solicitada:* ${acao.value}`,
        `*âš¡ Prioridade:* ${prio.value}`,
        `*ðŸ“… Prazo desejado:* ${prazoFmt}`,
        `*ðŸ‘· ResponsÃ¡vel/Equipe:* ${resp.value||'-'}`,
        `*ðŸ•’ Data/Hora (BrasÃ­lia):* ${dataHora}`,
        filesState.length? `*ðŸ“Ž Anexos:* ${anexos} arquivo(s)` : null,
        `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`,
        `*_*Registro para GestÃ£o*_*`
      ].filter(Boolean);
      return linhas.join('\n');
    }

    function updatePreview(){ preview.textContent = buildMessage(); }
    document.getElementById('btnPreview').addEventListener('click', updatePreview);
    document.getElementById('btnCopy').addEventListener('click', ()=>{ const text = buildMessage(); navigator.clipboard?.writeText(text).then(()=>{ preview.textContent = text + "\n\n(copiado para a Ã¡rea de transferÃªncia)"; }); });
    document.getElementById('btnClear').addEventListener('click', ()=>{ form.reset(); thumbs.innerHTML=''; filesState=[]; updatePreview(); });

    // ====== CARD ======
    function wrapText(ctx, text, x, y, maxW, lineH){ const words = text.split(/\s+/); let line=''; const lines=[]; for(let i=0;i<words.length;i++){ const test=line+words[i]+' '; if(ctx.measureText(test).width>maxW && i>0){ lines.push(line.trim()); line=words[i]+' '; } else { line=test; } } lines.push(line.trim()); lines.forEach((ln,i)=>ctx.fillText(ln,x,y+i*lineH)); return y+(lines.length-1)*lineH; }
    async function buildCardFile(){ const W=1080,H=1350,P=64; const ctx=cardCanvas.getContext('2d'); ctx.clearRect(0,0,W,H); const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#eaf6ff'); g.addColorStop(1,'#ffffff'); ctx.fillStyle=g; ctx.fillRect(0,0,W,H); ctx.fillStyle='#0f172a'; ctx.font='bold 48px Inter, Arial'; ctx.fillText('OCORRÃŠNCIA DE OBRA', P, P+8); const ref=makeRef(); ctx.font='bold 28px Inter, Arial'; ctx.fillStyle='#0ea5e9'; ctx.fillText(`Ref: ${ref}`, P, P+54); const boxY=P+90, boxH=H-boxY-180, boxR=28; ctx.fillStyle='#00000010'; ctx.fillRect(P+6,boxY+6,W-P*2,boxH); ctx.fillStyle='#ffffff'; ctx.strokeStyle='#e5eef7'; ctx.lineWidth=4; const bw=W-P*2,bh=boxH,x=P,y=boxY,r=boxR; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.lineTo(x+bw-r,y); ctx.quadraticCurveTo(x+bw,y,x+bw,y+r); ctx.lineTo(x+bw,y+bh-r); ctx.quadraticCurveTo(x+bw,y+bh,x+bw-r,y+bh); ctx.lineTo(x+r,y+bh); ctx.quadraticCurveTo(x,y+bh,x,y+bh-r); ctx.lineTo(x,y+r); ctx.quadraticCurveTo(x,y,x+r,y); ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.fillStyle='#0f172a'; ctx.font='600 34px Inter, Arial'; let yy=y+56; const lh=44, maxW=bw-40, xx=x+20; const linhas=[ `Tipo: ${tipo.value==='Outros' ? (outroTexto.value.trim()||'(descrever)') : (tipo.value||'(sem tipo)')}`, `Bloco/Setor: ${bloco.value||'-'}`, `Pav/Unidade: ${pav.value||'-'}`, `Local: ${localDet.value||'-'}`, `DescriÃ§Ã£o:`]; linhas.forEach(t=>{ ctx.fillText(t,xx,yy); yy+=lh; }); ctx.font='400 30px Inter, Arial'; yy=wrapText(ctx,(desc.value.trim()||'-'),xx,yy,maxW,40)+26; ctx.font='600 34px Inter, Arial'; [ `AÃ§Ã£o solicitada: ${acao.value}`, `Prioridade: ${prio.value}`, `Prazo desejado: ${prazo.value? isoBrDate(prazo.value): '-'}`, `Resp./Equipe: ${resp.value||'-'}`, `Data/Hora (BrasÃ­lia): ${nowBr()}` ].forEach(t=>{ ctx.fillText(t,xx,yy); yy+=lh; }); ctx.font='italic 700 26px Inter, Arial'; ctx.fillStyle='#64748b'; ctx.fillText('â€” Registro para GestÃ£o', P, H-90); ctx.save(); ctx.translate(W-140,H-70); ctx.rotate(-Math.PI/12); ctx.globalAlpha=0.08; ctx.fillStyle='#0ea5e9'; ctx.font='900 90px Inter, Arial'; ctx.fillText('SYSTEM', -200, 0); ctx.restore(); const blob = await new Promise(res=> cardCanvas.toBlob(res, 'image/png', 0.92)); return new File([blob], `ocorrencia_${ref}.png`, {type:'image/png'}); }

    // ====== Envio ======
    function openWhatsWithText(text, number){ const encoded = encodeURIComponent(text); const num = (number||'').replace(/\D/g,''); const base = num ? `https://wa.me/${num}?text=${encoded}` : `https://wa.me/?text=${encoded}`; window.open(base, '_blank'); }
    async function shareWithFiles(text){ const list=[...filesState.map(x=>x.file)]; if(chkCard.checked){ try{ const card=await buildCardFile(); list.unshift(card); }catch(e){} } if(list.length && navigator.canShare && navigator.canShare({ files:list })){ try{ await navigator.share({ files:list, text, title:'OcorrÃªncia de obra' }); return true; }catch(e){ return false; } } return false; }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!tipo.value){ alert('Selecione o tipo de ocorrÃªncia.'); return; }
      if(tipo.value==='Outros' && !outroTexto.value.trim()){ alert('Descreva a ocorrÃªncia em "Outros".'); return; }
      updatePreview();
      const text = buildMessage();
      const shared = await shareWithFiles(text);
      if(!shared){
        // fallback: abre o WhatsApp com o texto e oferece o card pra salvar manualmente
        if(chkCard.checked){ try{ const card=await buildCardFile(); const url=URL.createObjectURL(card); const w=window.open('about:blank','_blank'); if(w){ w.document.write(`<p style=\"font-family:system-ui,Arial\">Salve a imagem e anexe no WhatsApp:</p><img src=\"${url}\" style=\"max-width:100%;height:auto;border:1px solid #ddd;border-radius:8px\">`); w.document.close(); } }catch(e){} }
        openWhatsWithText(text, fone.value);
      }
    });
  </script>
</body>
</html>
